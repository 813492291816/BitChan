version: "2.4"

services:
  nginx:
    container_name: nginx
    networks:
      bc_net:
        ipv4_address: 172.28.1.1
    restart: always
    build:
      context: ../
      dockerfile: docker/nginx/Dockerfile
    volumes:
      - bitchan:/usr/local/bitchan
      - nginx:/usr/local/nginx
      - /etc/localtime:/etc/localtime:ro  # Use timezone of the host (read-only)
    ports:
      - "8000:8000"
    cpuset: '0'

  tor:
    container_name: tor
    networks:
      bc_net:
        ipv4_address: 172.28.1.2
    restart: always
    build:
      context: ../
      dockerfile: docker/tor/Dockerfile
      args:
        password: "torpass1234"  # also change TOR_PASS in config.py
    privileged: true
    volumes:
      - nginx:/usr/local/nginx
      - tor:/usr/local/tor
      - tor_etc:/etc/tor
    cpuset: '0'
    command: tor -f /etc/tor/torrc
    depends_on:
      - nginx

  bitmessage:
    container_name: bitmessage
    image: app
    networks:
      bc_net:
        ipv4_address: 172.28.1.3
    restart: always
    build:
      context: ../
      dockerfile: docker/Dockerfile
    volumes:
      - bitchan:/usr/local/bitchan
      - bitmessage:/usr/local/bitmessage
      - /etc/localtime:/etc/localtime:ro  # Use timezone of the host (read-only)
    privileged: true
    command: >
      bash -c "/home/bitchan/database/upgrade_database.sh &&
               /usr/local/bin/pybitmessage -d"
    depends_on:
      - tor

  bitchan_flask:
    container_name: bitchan_flask
    image: app
    networks:
      bc_net:
        ipv4_address: 172.28.1.4
    restart: always
    working_dir: /home/bitchan
    volumes:
      - bitchan:/usr/local/bitchan
      - bitmessage:/usr/local/bitmessage
      - tor:/usr/local/tor
      - tor_etc:/etc/tor
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For bitchan to control docker containers
      - /etc/localtime:/etc/localtime:ro  # Use timezone of the host (read-only)
    privileged: true
    cpuset: '0'
    command: gunicorn --workers 1 --worker-class gthread --threads 4 --timeout 1800 --bind unix:/usr/local/bitchan/bitchan.sock bitchan_flask:app
    depends_on:
      - bitmessage

  bitchan_daemon:
    container_name: bitchan_daemon
    image: app
    networks:
      bc_net:
        ipv4_address: 172.28.1.5
    restart: always
    working_dir: /home/bitchan
    volumes:
      - bitchan:/usr/local/bitchan
      - bitmessage:/usr/local/bitmessage
      - tor:/usr/local/tor
      - tor_etc:/etc/tor
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For bitchan to control docker containers
      - /etc/localtime:/etc/localtime:ro  # Use timezone of the host (read-only)
    privileged: true
    cpuset: '0'
    command: bash -c "PYTHONPATH=/home/bitchan python3 bitchan_daemon.py"
    depends_on:
      - bitchan_flask

volumes:
  bitchan:
  bitmessage:
  nginx:
  tor:
  tor_etc:

networks:
    bc_net:
        ipam:
            driver: default
            config:
                - subnet: 172.28.0.0/16
